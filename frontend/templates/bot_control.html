{% extends "base.html" %}

{% block title %}Controllo Bot - Trading Bot{% endblock %}

{% block extra_css %}
<style>
/* Symbol Search Dropdown */
.position-relative .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1050;
    display: none;
    background-color: var(--bs-dark);
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
}

.position-relative .dropdown-menu.show {
    display: block;
}

.dropdown-item {
    color: var(--bs-body-color);
    padding: 0.5rem 1rem;
    border: none;
    background: none;
}

.dropdown-item:hover {
    background-color: var(--bs-secondary);
    color: var(--bs-body-color);
}

.dropdown-item:focus {
    background-color: var(--bs-primary);
    color: white;
}

/* Symbol search input */
#symbol-search {
    background-color: var(--bs-dark);
    border-color: var(--bs-border-color);
    color: var(--bs-body-color);
}

#symbol-search:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    background-color: var(--bs-dark);
    color: var(--bs-body-color);
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Bot Control Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ü§ñ Pannello di Controllo Bot</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <div id="bot-status-indicator" class="status-indicator status-offline me-3"></div>
                            <div>
                                <h6 class="mb-0">Stato Bot</h6>
                                <small class="text-muted" id="bot-status-text">Offline</small>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex">
                            <button class="btn btn-success" id="start-bot-btn" onclick="startBot()">
                                <i class="fas fa-play"></i> Avvia Bot
                            </button>
                            <button class="btn btn-danger" id="stop-bot-btn" onclick="stopBot()" disabled>
                                <i class="fas fa-stop"></i> Ferma Bot
                            </button>
                            <button class="btn btn-warning" onclick="restartBot()">
                                <i class="fas fa-redo"></i> Riavvia
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>üìä Statistiche Sessione</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <div class="fw-bold" id="trades-count">0</div>
                                    <small class="text-muted">Trades</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <div class="fw-bold text-success" id="profit-trades">0</div>
                                    <small class="text-muted">Profitti</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <div class="fw-bold text-danger" id="loss-trades">0</div>
                                    <small class="text-muted">Perdite</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">‚öôÔ∏è Configurazione Bot</h5>
            </div>
            <div class="card-body">
                <form id="bot-settings-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="symbol" class="form-label">
                                    Simbolo Trading
                                    <button type="button" class="btn btn-link btn-sm p-0 ms-2" 
                                            data-bs-toggle="modal" data-bs-target="#addSymbolModal">
                                        <i class="fas fa-plus"></i> Aggiungi
                                    </button>
                                </label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="symbol-search" 
                                           placeholder="Cerca simbolo..." autocomplete="off">
                                    <input type="hidden" id="symbol" name="symbol" value="AVAXUSDT">
                                    <div id="symbol-dropdown" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <div class="form-text">
                                    <small id="selected-symbol-info" class="text-muted">Simbolo selezionato: AVAX/USDT</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantit√† (USDT)</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" 
                                       value="50" min="10" step="10">
                            </div>
                            
                            <div class="mb-3">
                                <label for="operation" class="form-label">Tipo Operazione</label>
                                <select class="form-select" id="operation" name="operation">
                                    <option value="true">Long (Buy)</option>
                                    <option value="false">Short (Sell)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ema_period" class="form-label">Periodo EMA</label>
                                <input type="number" class="form-control" id="ema_period" name="ema_period" 
                                       value="10" min="5" max="200">
                            </div>
                            
                            <div class="mb-3">
                                <label for="interval" class="form-label">Intervallo (minuti)</label>
                                <select class="form-select" id="interval" name="interval">
                                    <option value="1">1 minuto</option>
                                    <option value="5">5 minuti</option>
                                    <option value="15">15 minuti</option>
                                    <option value="30" selected>30 minuti</option>
                                    <option value="60">1 ora</option>
                                    <option value="240">4 ore</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="open_candles" class="form-label">Candele per Apertura</label>
                                <input type="number" class="form-control" id="open_candles" name="open_candles" 
                                       value="3" min="1" max="10">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stop_candles" class="form-label">Candele per Stop</label>
                                <input type="number" class="form-control" id="stop_candles" name="stop_candles" 
                                       value="3" min="1" max="10">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="distance" class="form-label">Distanza EMA (%)</label>
                                <input type="number" class="form-control" id="distance" name="distance" 
                                       value="1" min="0.1" max="10" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salva Configurazione
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetSettings()">
                            <i class="fas fa-undo"></i> Reset Default
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Active Positions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìà Posizioni Attive</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Simbolo</th>
                                <th>Tipo</th>
                                <th>Quantit√†</th>
                                <th>Prezzo Entrata</th>
                                <th>Prezzo Corrente</th>
                                <th>PnL</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="active-positions">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    Nessuna posizione attiva
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Log Panel -->
    <div class="col-lg-4">
        <div class="card" style="height: 600px;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìù Log Bot</h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Pulisci
                </button>
            </div>
            <div class="card-body p-0">
                <div id="bot-logs" style="height: 540px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; padding: 15px; background-color: #1e1e1e; color: #fff;">
                    <div class="text-muted">In attesa di attivit√† del bot...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let botRunning = false;

// Inizializza la pagina
document.addEventListener('DOMContentLoaded', function() {
    loadBotStatus();
    loadSettings();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Form submission
    document.getElementById('bot-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSettings();
    });
    
    // Socket events
    socket.on('bot_update', function(data) {
        // Log dettagliato del bot update
        const time = new Date().toLocaleTimeString();
        let message = data.message;
        
        // Aggiungi informazioni extra se disponibili
        if (data.price) {
            message += ` - Prezzo: $${data.price}`;
        }
        if (data.ema_value) {
            message += ` - EMA: $${data.ema_value.toFixed(4)}`;
        }
        if (data.active_trades > 0) {
            message += ` - Trade attivi: ${data.active_trades}`;
        }
        
        addLog(`[${time}] ${message}`, 'info');
        updateBotStatus(data.status === 'running');
    });
    
    socket.on('bot_error', function(data) {
        addLog(`[${new Date().toLocaleTimeString()}] ERRORE: ${data.error}`, 'error');
        updateBotStatus(false);
    });
    
    // Nuovo evento per log dettagliati di analisi
    socket.on('analysis_log', function(data) {
        const time = new Date().toLocaleTimeString();
        addLog(`[${time}] ${data.message}`, data.type || 'info');
    });
    
    // Evento per notifiche trade
    socket.on('trade_notification', function(data) {
        const time = new Date().toLocaleTimeString();
        const side = data.side || 'UNKNOWN';
        const symbol = data.symbol || '';
        const price = data.price ? `$${data.price}` : '';
        
        let message = '';
        if (data.type === 'POSITION_OPENED') {
            message = `üöÄ POSIZIONE ${side} APERTA - ${symbol} @ ${price}`;
        } else if (data.type === 'POSITION_CLOSED') {
            message = `‚úÖ POSIZIONE ${side} CHIUSA - ${symbol} @ ${price}`;
        } else {
            message = `üì¢ ${data.type}: ${side} ${symbol} @ ${price}`;
        }
        
        addLog(`[${time}] ${message}`, 'success');
        
        // Mostra anche come notifica
        showAlert(message, 'success');
    });
}

// Carica lo stato del bot
function loadBotStatus() {
    fetch('/api/bot/status')
        .then(response => response.json())
        .then(data => {
            updateBotStatus(data.running);
            botRunning = data.running;
        })
        .catch(error => {
            console.error('Errore caricamento stato bot:', error);
        });
}

// Carica le impostazioni
function loadSettings() {
    fetch('/api/bot/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('symbol').value = data.symbol || 'AVAXUSDT';
            document.getElementById('quantity').value = data.quantity || 50;
            document.getElementById('operation').value = data.operation || true;
            document.getElementById('ema_period').value = data.ema_period || 10;
            document.getElementById('interval').value = data.interval || 30;
            document.getElementById('open_candles').value = data.open_candles || 3;
            document.getElementById('stop_candles').value = data.stop_candles || 3;
            document.getElementById('distance').value = data.distance || 1;
        })
        .catch(error => {
            console.error('Errore caricamento impostazioni:', error);
        });
}

// Salva le impostazioni
function saveSettings() {
    const formData = new FormData(document.getElementById('bot-settings-form'));
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
        if (key === 'operation') {
            settings[key] = value === 'true';
        } else if (['quantity', 'ema_period', 'interval', 'open_candles', 'stop_candles', 'distance'].includes(key)) {
            settings[key] = parseFloat(value);
        } else {
            settings[key] = value;
        }
    }
    
    fetch('/api/bot/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Impostazioni salvate con successo', 'success');
            addLog(`[${new Date().toLocaleTimeString()}] Impostazioni aggiornate`, 'info');
        } else {
            showAlert('Errore nel salvataggio: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Errore di connessione', 'danger');
    });
}

// Avvia il bot
function startBot() {
    if (botRunning) {
        showAlert('Il bot √® gi√† in esecuzione', 'warning');
        return;
    }
    
    const settings = getFormSettings();
    
    fetch('/api/bot/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            addLog(`[${new Date().toLocaleTimeString()}] Bot avviato`, 'success');
            updateBotStatus(true);
        } else {
            showAlert('Errore: ' + data.error, 'danger');
            addLog(`[${new Date().toLocaleTimeString()}] Errore avvio: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showAlert('Errore di connessione', 'danger');
        addLog(`[${new Date().toLocaleTimeString()}] Errore connessione`, 'error');
    });
}

// Ferma il bot
function stopBot() {
    if (!botRunning) {
        showAlert('Il bot non √® in esecuzione', 'warning');
        return;
    }
    
    fetch('/api/bot/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'warning');
            addLog(`[${new Date().toLocaleTimeString()}] Bot fermato`, 'warning');
            updateBotStatus(false);
        } else {
            showAlert('Errore: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Errore di connessione', 'danger');
    });
}

// Riavvia il bot
function restartBot() {
    if (botRunning) {
        stopBot();
        setTimeout(() => {
            startBot();
        }, 2000);
    } else {
        startBot();
    }
}

// Ottieni impostazioni dal form
function getFormSettings() {
    return {
        symbol: document.getElementById('symbol').value,
        quantity: parseFloat(document.getElementById('quantity').value),
        operation: document.getElementById('operation').value === 'true',
        ema_period: parseInt(document.getElementById('ema_period').value),
        interval: parseInt(document.getElementById('interval').value),
        open_candles: parseInt(document.getElementById('open_candles').value),
        stop_candles: parseInt(document.getElementById('stop_candles').value),
        distance: parseFloat(document.getElementById('distance').value),
        category: 'linear'
    };
}

// Aggiorna stato bot UI
function updateBotStatus(isRunning) {
    botRunning = isRunning;
    const indicator = document.getElementById('bot-status-indicator');
    const text = document.getElementById('bot-status-text');
    const startBtn = document.getElementById('start-bot-btn');
    const stopBtn = document.getElementById('stop-bot-btn');
    
    if (isRunning) {
        indicator.className = 'status-indicator status-online me-3';
        text.textContent = 'Online - Bot in esecuzione';
        startBtn.disabled = true;
        stopBtn.disabled = false;
    } else {
        indicator.className = 'status-indicator status-offline me-3';
        text.textContent = 'Offline - Bot fermo';
        startBtn.disabled = false;
        stopBtn.disabled = true;
    }
}

// Aggiungi log
function addLog(message, type = 'info') {
    const logsContainer = document.getElementById('bot-logs');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry mb-1';
    
    let color = '#ffffff';
    let icon = '';
    switch (type) {
        case 'success':
            color = '#22c55e';
            icon = '‚úÖ';
            break;
        case 'error':
            color = '#ef4444';
            icon = '‚ùå';
            break;
        case 'warning':
            color = '#f59e0b';
            icon = '‚ö†Ô∏è';
            break;
        case 'info':
            color = '#3b82f6';
            icon = 'üîµ';
            break;
    }
    
    logEntry.style.color = color;
    logEntry.innerHTML = `<span style="opacity: 0.7;">${icon}</span> ${message}`;
    
    logsContainer.appendChild(logEntry);
    
    // Auto-scroll al bottom
    logsContainer.scrollTop = logsContainer.scrollHeight;
    
    // Limita il numero di log (mantieni solo gli ultimi 100)
    const logEntries = logsContainer.querySelectorAll('.log-entry');
    if (logEntries.length > 100) {
        logEntries[0].remove();
    }
}


// Pulisci log
function clearLogs() {
    document.getElementById('bot-logs').innerHTML = 
        '<div class="text-muted">Log puliti - In attesa di attivit√†...</div>';
}

// Reset impostazioni
function resetSettings() {
    document.getElementById('symbol').value = 'AVAXUSDT';
    document.getElementById('quantity').value = 50;
    document.getElementById('operation').value = 'true';
    document.getElementById('ema_period').value = 10;
    document.getElementById('interval').value = 30;
    document.getElementById('open_candles').value = 3;
    document.getElementById('stop_candles').value = 3;
    document.getElementById('distance').value = 1;
    
    showAlert('Impostazioni resettate ai valori di default', 'info');
}

// ==================== GESTIONE SIMBOLI ====================

let allSymbols = [];
let currentSymbols = [];

// Carica tutti i simboli
async function loadSymbols() {
    try {
        const response = await fetch('/api/symbols');
        const data = await response.json();
        if (data.success) {
            allSymbols = data.symbols;
            currentSymbols = allSymbols;
            updateSymbolDropdown();
            
            // Imposta il simbolo corrente se esiste
            const currentSymbol = document.getElementById('symbol').value;
            const symbolData = allSymbols.find(s => s.symbol === currentSymbol);
            if (symbolData) {
                updateSelectedSymbol(symbolData.symbol, symbolData.name);
            }
        }
    } catch (error) {
        console.error('Errore nel caricamento simboli:', error);
    }
}

// Aggiorna il dropdown dei simboli
function updateSymbolDropdown() {
    const dropdown = document.getElementById('symbol-dropdown');
    dropdown.innerHTML = '';
    
    currentSymbols.forEach(symbolData => {
        const item = document.createElement('a');
        item.className = 'dropdown-item d-flex justify-content-between';
        item.href = '#';
        item.innerHTML = `
            <span>${symbolData.name}</span>
            <small class="text-muted">${symbolData.symbol}</small>
        `;
        item.onclick = (e) => {
            e.preventDefault();
            selectSymbol(symbolData.symbol, symbolData.name);
        };
        dropdown.appendChild(item);
    });
}

// Seleziona un simbolo
function selectSymbol(symbol, name) {
    updateSelectedSymbol(symbol, name);
    hideSymbolDropdown();
}

// Aggiorna il simbolo selezionato
function updateSelectedSymbol(symbol, name) {
    document.getElementById('symbol').value = symbol;
    document.getElementById('symbol-search').value = name;
    document.getElementById('selected-symbol-info').textContent = `Simbolo selezionato: ${name}`;
}

// Mostra/nasconde dropdown
function showSymbolDropdown() {
    document.getElementById('symbol-dropdown').classList.add('show');
}

function hideSymbolDropdown() {
    document.getElementById('symbol-dropdown').classList.remove('show');
}

// Filtra simboli in base alla ricerca
function filterSymbols(query) {
    if (!query.trim()) {
        currentSymbols = allSymbols;
    } else {
        const lowerQuery = query.toLowerCase();
        currentSymbols = allSymbols.filter(s => 
            s.symbol.toLowerCase().includes(lowerQuery) || 
            s.name.toLowerCase().includes(lowerQuery)
        );
    }
    updateSymbolDropdown();
}

// Event listeners per la ricerca simboli
document.getElementById('symbol-search').addEventListener('input', (e) => {
    filterSymbols(e.target.value);
    showSymbolDropdown();
});

document.getElementById('symbol-search').addEventListener('focus', () => {
    showSymbolDropdown();
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('.position-relative')) {
        hideSymbolDropdown();
    }
});

// Aggiunge un nuovo simbolo
async function addNewSymbol() {
    const symbol = document.getElementById('new-symbol').value.trim().toUpperCase();
    const name = document.getElementById('new-symbol-name').value.trim();
    
    if (!symbol || !name) {
        showAlert('Inserisci sia il simbolo che il nome', 'warning');
        return;
    }
    
    // Mostra loading
    const addBtn = document.getElementById('add-symbol-btn');
    const originalText = addBtn.innerHTML;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifica...';
    addBtn.disabled = true;
    
    try {
        const response = await fetch('/api/symbols/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symbol, name })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            
            // Ricarica i simboli
            await loadSymbols();
            
            // Chiudi modal
            bootstrap.Modal.getInstance(document.getElementById('addSymbolModal')).hide();
            
            // Reset form
            document.getElementById('new-symbol').value = '';
            document.getElementById('new-symbol-name').value = '';
            
            // Seleziona il nuovo simbolo
            selectSymbol(data.symbol.symbol, data.symbol.name);
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Errore nella connessione', 'danger');
    } finally {
        addBtn.innerHTML = originalText;
        addBtn.disabled = false;
    }
}

// Inizializza simboli al caricamento
document.addEventListener('DOMContentLoaded', () => {
    loadSymbols();
});
</script>

<!-- Modal Aggiungi Simbolo -->
<div class="modal fade" id="addSymbolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle text-primary me-2"></i>
                    Aggiungi Nuovo Simbolo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-symbol" class="form-label">Simbolo</label>
                    <input type="text" class="form-control" id="new-symbol" 
                           placeholder="es. LINKUSDT" oninput="this.value = this.value.toUpperCase()">
                    <div class="form-text">Inserisci il simbolo esatto come su Bybit (es. LINKUSDT, MATICUSDT)</div>
                </div>
                <div class="mb-3">
                    <label for="new-symbol-name" class="form-label">Nome Visualizzato</label>
                    <input type="text" class="form-control" id="new-symbol-name" 
                           placeholder="es. LINK/USDT">
                    <div class="form-text">Nome che apparir√† nel menu di selezione</div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Il simbolo verr√† verificato su Bybit prima di essere aggiunto
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="add-symbol-btn" onclick="addNewSymbol()">
                    <i class="fas fa-check me-1"></i> Aggiungi Simbolo
                </button>
            </div>
        </div>
    </div>
</div>
</script>
{% endblock %}
